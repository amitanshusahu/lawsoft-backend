// Auto-generated by Cursor — Lawsuit backend
// Express app: sets up middleware (helmet, cors, json parser, request id, pino logger), mounts routes, and error handlers.
import express from 'express';
import helmet from 'helmet';
import cors from 'cors';
import pinoHttp from 'pino-http';
import config from './config/index.js';
// dynamic import config to work with ESM runtime (tsx / node --loader)
// const configModule = await import('./config/index.js');
// const { config } = configModule as any;
import { randomUUID } from 'crypto';
const app = express();
// Security and parsing
app.use(helmet());
app.use(cors({ origin: config.cors.origin ?? true }));
app.use(express.json({ limit: '10mb' }));
// Request ID middleware — generate a stable request id if missing
app.use((req, _res, next) => {
    const header = req.headers['x-request-id'];
    const rid = typeof header === 'string' && header.trim().length > 0 ? header : randomUUID();
    // store on header for downstream access
    req.headers['x-request-id'] = rid;
    // also expose on request object for convenience
    req.id = rid;
    next();
});
// Pino HTTP logger
app.use(pinoHttp({ level: config.logLevel }));
// Mount API routes if available (optional)
try {
    // dynamic import keeps startup resilient when routes are not yet implemented
    // use concatenation to avoid TypeScript static path resolution checks
    const routesModule = await import('./routes' + '/index.js');
    const router = routesModule && (routesModule.default || routesModule);
    if (router) {
        // router is an Express middleware (Router) — mount it directly under /api/v1
        app.use('/api/v1', router);
    }
    else {
        app.get('/api/v1/health', (_req, res) => res.json({ success: true, uptime: process.uptime() }));
    }
}
catch (err) {
    // routes not present yet — expose a minimal health endpoint
    app.get('/api/v1/health', (_req, res) => res.json({ success: true, uptime: process.uptime() }));
}
// 404 handler
app.use((_req, res) => {
    res.status(404).json({ success: false, error: { code: 'not_found', message: 'Route not found' } });
});
// Error handler
app.use((err, _req, res, _next) => {
    const error = err;
    const status = error?.status ?? 500;
    const message = error?.message ?? 'Internal Server Error';
    // don't leak stack in production
    if (config.nodeEnv !== 'production') {
        // eslint-disable-next-line no-console
        console.error(error);
    }
    res.status(status).json({ success: false, error: { code: error?.code ?? 'server_error', message } });
});
export default app;
//# sourceMappingURL=app.js.map